# SPDX-FileCopyrightText: 2026 TII (SSRC) and the Ghaf contributors
#
# SPDX-License-Identifier: Apache-2.0

name: Update robot-framework flake input

on:
  schedule:
    # 06:00 EET (UTC+2)
    - cron: "0 4 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-robot-framework:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0
          persist-credentials: false

      - name: Install nix
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31.9.0

      - name: Update robot-framework flake input
        shell: bash
        run: nix flake lock --update-input robot-framework

      - name: Detect changes
        id: changes
        shell: bash
        run: |
          if git diff --quiet -- flake.lock; then
            echo "has_changes=false" >>"$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >>"$GITHUB_OUTPUT"
          fi

      - name: Create or update pull request
        if: steps.changes.outputs.has_changes == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_BRANCH: ${{ github.event.repository.default_branch }}
          BRANCH_NAME: automation/update-robot-framework
          PR_TITLE: "flake.lock: update robot-framework input"
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git switch -C "$BRANCH_NAME"
          git add flake.lock
          git commit -m "$PR_TITLE" \
            -m "Automated update of the robot-framework flake input." \
            -m "Signed-off-by: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

          git push --force-with-lease \
            "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" \
            "$BRANCH_NAME"

          cat >pr-body.md <<'EOF'
          This PR updates the `robot-framework` flake input in `flake.lock`.

          - Trigger: daily automation (`04:00 UTC`, around `06:00 EET`) or manual workflow dispatch.
          - Command run: `nix flake lock --update-input robot-framework`
          EOF

          pr_number="$(gh pr list --base "$BASE_BRANCH" --head "$BRANCH_NAME" --state open --json number --jq '.[0].number')"

          if [ -n "$pr_number" ]; then
            gh pr edit "$pr_number" --title "$PR_TITLE" --body-file pr-body.md
          else
            gh pr create --base "$BASE_BRANCH" --head "$BRANCH_NAME" --title "$PR_TITLE" --body-file pr-body.md
          fi
